<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - Galaxy S21 FastAPI Server</title>
    <!-- TailwindCSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HTMX via CDN -->
    <script src="https://unpkg.com/htmx.org@1.9.11"></script>
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card {
            @apply bg-white rounded-lg shadow-md p-4 mb-4;
        }
        .card-title {
            @apply text-lg font-semibold text-gray-800 mb-3 border-b pb-2;
        }
        .loading::after {
            content: " ⚙️";
            animation: dots 1s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: " ⚙️"; }
            40% { content: " ⚙️⚙️"; }
            60% { content: " ⚙️⚙️⚙️"; }
            80%, 100% { content: " ⚙️⚙️⚙️⚙️"; }
        }
        .gauge-container {
            position: relative;
            margin: 1rem auto;
            width: 120px;
            height: 120px;
        }
        .gauge-bg {
            width: 100%;
            height: 100%;
            background-color: #f3f4f6;
            border-radius: 50%;
        }
        .gauge-fill {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            clip-path: polygon(50% 50%, 100% 50%, 100% 0, 0 0, 0 50%);
            transform-origin: 50% 50%;
            transform: rotate(0deg);
            transition: transform 1s ease-out;
        }
        .gauge-cover {
            position: absolute;
            top: 10%;
            left: 10%;
            width: 80%;
            height: 80%;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <header class="bg-white shadow-md rounded-lg p-6 mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">시스템 모니터링 대시보드</h1>
                <p class="text-gray-600">Galaxy S21 FastAPI Server</p>
            </div>
            <div class="flex space-x-4">
                <a href="/" class="text-blue-500 hover:text-blue-700">홈</a>
                <a href="/docs" class="text-blue-500 hover:text-blue-700">API 문서</a>
                <div 
                    class="text-green-600"
                    hx-get="/api/status"
                    hx-trigger="load, every 60s"
                    hx-swap="innerHTML">
                    Online
                </div>
            </div>
        </header>

        <!-- System Info -->
        <div class="card">
            <h2 class="card-title">시스템 정보</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <p class="text-gray-600">호스트명:</p>
                    <p class="font-bold">{{ system_info.hostname }}</p>
                </div>
                <div>
                    <p class="text-gray-600">플랫폼:</p>
                    <p class="font-bold">{{ system_info.platform }}</p>
                </div>
                <div>
                    <p class="text-gray-600">프로세서:</p>
                    <p class="font-bold">{{ system_info.processor }}</p>
                </div>
                <div>
                    <p class="text-gray-600">Python 버전:</p>
                    <p class="font-bold">{{ system_info.python_version }}</p>
                </div>
                <div>
                    <p class="text-gray-600">가동 시간:</p>
                    <p class="font-bold" id="uptime">{{ system_info.uptime }}</p>
                </div>
                <div>
                    <p class="text-gray-600">현재 시간:</p>
                    <p class="font-bold" id="current-time"></p>
                </div>
            </div>
        </div>

        <!-- Real-time Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <!-- CPU Usage -->
            <div class="card">
                <h2 class="card-title">CPU 사용량</h2>
                <div
                    id="cpu-gauge-container"
                    hx-get="/api/monitoring/current"
                    hx-trigger="load, every 5s"
                    hx-indicator=".loading"
                    hx-swap="none">
                    <div class="gauge-container">
                        <div class="gauge-bg"></div>
                        <div class="gauge-fill" style="background-color: #3b82f6;"></div>
                        <div class="gauge-cover">
                            <span id="cpu-percent">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Memory Usage -->
            <div class="card">
                <h2 class="card-title">메모리 사용량</h2>
                <div
                    id="memory-gauge-container"
                    hx-trigger="none">
                    <div class="gauge-container">
                        <div class="gauge-bg"></div>
                        <div class="gauge-fill" style="background-color: #10b981;"></div>
                        <div class="gauge-cover">
                            <span id="memory-percent">0%</span>
                        </div>
                    </div>
                    <div class="text-center text-sm text-gray-600">
                        <span id="memory-used">0</span> / <span id="memory-total">0</span> MB
                    </div>
                </div>
            </div>

            <!-- Disk Usage -->
            <div class="card">
                <h2 class="card-title">디스크 사용량</h2>
                <div
                    id="disk-gauge-container"
                    hx-trigger="none">
                    <div class="gauge-container">
                        <div class="gauge-bg"></div>
                        <div class="gauge-fill" style="background-color: #f59e0b;"></div>
                        <div class="gauge-cover">
                            <span id="disk-percent">0%</span>
                        </div>
                    </div>
                    <div class="text-center text-sm text-gray-600">
                        <span id="disk-used">0</span> / <span id="disk-total">0</span> GB
                    </div>
                </div>
            </div>

            <!-- Process Count -->
            <div class="card">
                <h2 class="card-title">프로세스</h2>
                <div
                    id="process-container"
                    hx-trigger="none">
                    <div class="text-center">
                        <span id="process-count" class="text-4xl font-bold text-indigo-600">0</span>
                        <p class="text-gray-600">실행 중인 프로세스</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Battery Info -->
        <div class="card" id="battery-card">
            <h2 class="card-title">배터리 상태</h2>
            <div id="battery-info" class="flex items-center">
                <div class="flex-1">
                    <div class="relative h-6 bg-gray-200 rounded-full overflow-hidden">
                        <div id="battery-bar" class="h-full bg-green-500" style="width: 0%"></div>
                    </div>
                </div>
                <div class="ml-4 flex items-center">
                    <span id="battery-percent" class="text-lg font-semibold">0%</span>
                    <span id="battery-charging" class="ml-2 text-green-500 hidden">⚡</span>
                </div>
            </div>
            <p id="battery-time" class="mt-2 text-sm text-gray-600"></p>
        </div>

        <!-- Historical Charts -->
        <div class="card">
            <h2 class="card-title">
                시스템 리소스 기록
                <span class="text-sm font-normal text-gray-500 ml-2">최근 10분</span>
            </h2>
            <div class="h-64">
                <canvas id="resourceChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Update current time
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString();
        }
        updateTime();
        setInterval(updateTime, 1000);

        // Initialize charts
        const ctx = document.getElementById('resourceChart').getContext('2d');
        const resourceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array(60).fill(''),
                datasets: [{
                    label: 'CPU (%)',
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    data: Array(60).fill(0),
                    tension: 0.4
                }, {
                    label: '메모리 (%)',
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    data: Array(60).fill(0),
                    tension: 0.4
                }, {
                    label: '디스크 (%)',
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    data: Array(60).fill(0),
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: '사용률 (%)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '시간'
                        }
                    }
                },
                animation: {
                    duration: 500
                },
                plugins: {
                    legend: {
                        position: 'top',
                    }
                }
            }
        });

        // Update gauge function
        function updateGauge(id, percent) {
            const rotation = (percent / 100) * 180;
            const fill = document.querySelector(`#${id}-gauge-container .gauge-fill`);
            const display = document.getElementById(`${id}-percent`);
            
            fill.style.transform = `rotate(${rotation}deg)`;
            display.textContent = `${percent}%`;
            
            // Update color based on value
            if (percent > 80) {
                fill.style.backgroundColor = '#ef4444'; // red
            } else if (percent > 60) {
                fill.style.backgroundColor = '#f59e0b'; // amber
            } else {
                // Keep original color
            }
        }

        // Fetch historical data on load
        window.addEventListener('load', function() {
            fetch('/api/monitoring/history')
                .then(response => response.json())
                .then(data => {
                    if (data.timestamps && data.timestamps.length > 0) {
                        resourceChart.data.labels = data.timestamps;
                        resourceChart.data.datasets[0].data = data.cpu;
                        resourceChart.data.datasets[1].data = data.memory;
                        resourceChart.data.datasets[2].data = data.disk;
                        resourceChart.update();
                    }
                })
                .catch(error => console.error('Error fetching history:', error));
        });

        // Process monitoring data
        document.addEventListener('htmx:afterRequest', function(event) {
            if (event.detail.target.id === 'cpu-gauge-container') {
                try {
                    const data = JSON.parse(event.detail.xhr.responseText);
                    
                    // Update CPU gauge
                    updateGauge('cpu', data.cpu.percent);
                    
                    // Update Memory gauge
                    updateGauge('memory', data.memory.percent);
                    document.getElementById('memory-used').textContent = data.memory.used.toLocaleString();
                    document.getElementById('memory-total').textContent = data.memory.total.toLocaleString();
                    
                    // Update Disk gauge
                    updateGauge('disk', data.disk.percent);
                    document.getElementById('disk-used').textContent = data.disk.used.toLocaleString();
                    document.getElementById('disk-total').textContent = data.disk.total.toLocaleString();
                    
                    // Update Process count
                    document.getElementById('process-count').textContent = data.process_count;
                    
                    // Update Battery info if available
                    if (data.battery && Object.keys(data.battery).length > 0) {
                        document.getElementById('battery-card').classList.remove('hidden');
                        const batteryPercent = data.battery.percent;
                        document.getElementById('battery-percent').textContent = `${batteryPercent}%`;
                        document.getElementById('battery-bar').style.width = `${batteryPercent}%`;
                        
                        // Change color based on percentage
                        let batteryColor = 'bg-green-500';
                        if (batteryPercent < 20) {
                            batteryColor = 'bg-red-500';
                        } else if (batteryPercent < 50) {
                            batteryColor = 'bg-yellow-500';
                        }
                        document.getElementById('battery-bar').className = `h-full ${batteryColor}`;
                        
                        // Show charging icon if plugged in
                        const chargingIcon = document.getElementById('battery-charging');
                        if (data.battery.power_plugged) {
                            chargingIcon.classList.remove('hidden');
                        } else {
                            chargingIcon.classList.add('hidden');
                        }
                        
                        // Show time left if not plugged in
                        if (!data.battery.power_plugged && data.battery.secsleft > 0) {
                            const hoursLeft = Math.floor(data.battery.secsleft / 3600);
                            const minsLeft = Math.floor((data.battery.secsleft % 3600) / 60);
                            document.getElementById('battery-time').textContent = 
                                `남은 시간: 약 ${hoursLeft}시간 ${minsLeft}분`;
                        } else if (data.battery.power_plugged) {
                            document.getElementById('battery-time').textContent = '충전 중';
                        } else {
                            document.getElementById('battery-time').textContent = '';
                        }
                    } else {
                        document.getElementById('battery-card').classList.add('hidden');
                    }
                    
                    // Fetch history data to update chart
                    fetch('/api/monitoring/history')
                        .then(response => response.json())
                        .then(historyData => {
                            if (historyData.timestamps && historyData.timestamps.length > 0) {
                                resourceChart.data.labels = historyData.timestamps;
                                resourceChart.data.datasets[0].data = historyData.cpu;
                                resourceChart.data.datasets[1].data = historyData.memory;
                                resourceChart.data.datasets[2].data = historyData.disk;
                                resourceChart.update();
                            }
                        })
                        .catch(error => console.error('Error fetching history:', error));
                } catch (error) {
                    console.error('Error processing monitoring data:', error);
                }
            }
        });
    </script>
</body>
</html> 